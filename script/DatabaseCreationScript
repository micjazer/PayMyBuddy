-- Création du schéma de la base de données
CREATE DATABASE IF NOT EXISTS pay_my_buddy;
USE pay_my_buddy;

-- Création de la table USER
CREATE TABLE USER (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_name VARCHAR(45) NOT NULL,
    email VARCHAR(45) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    date_created DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT user_name_UNIQUE UNIQUE (user_name)
);

-- Création de la table BANK_ACCOUNT
CREATE TABLE BANK_ACCOUNT (
    id INT AUTO_INCREMENT PRIMARY KEY,
    iban VARCHAR(45) NOT NULL UNIQUE
);

-- Création de la table USER_ACCOUNT
CREATE TABLE USER_ACCOUNT (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    balance DECIMAL(15, 2) DEFAULT 0.00,
    CONSTRAINT fk_USER_ACCOUNT_USER_id FOREIGN KEY (user_id) REFERENCES USER(id) ON DELETE CASCADE
);

-- Création de la table ACCOUNT_ID
CREATE TABLE ACCOUNT_ID (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_account_id INT NOT NULL,
    bank_account_id INT NOT NULL,
    CONSTRAINT fk_USER_ACCOUNT_user_account_id FOREIGN KEY (user_account_id) REFERENCES USER_ACCOUNT(id) ON DELETE CASCADE,
    CONSTRAINT fk_BANK_ACCOUNT_bank_account_id FOREIGN KEY (bank_account_id) REFERENCES BANK_ACCOUNT(id) ON DELETE CASCADE
);

-- Création de la table TRANSACTION
CREATE TABLE TRANSACTION (
    id INT AUTO_INCREMENT PRIMARY KEY,
    amount DECIMAL(15, 2) NOT NULL,
    sender_id INT NOT NULL,
    receiver_id INT NOT NULL,
    description VARCHAR(45),
    fee DECIMAL(10, 2) DEFAULT 0.00,
    date_created DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_TRANSACTION_RELATION_ACCOUNT_sender_id FOREIGN KEY (sender_id) REFERENCES USER_ACCOUNT(id) ON DELETE CASCADE,
    CONSTRAINT fk_TRANSACTION_RELATION_ACCOUNT_receiver_id FOREIGN KEY (receiver_id) REFERENCES USER_ACCOUNT(id) ON DELETE CASCADE
);

-- Création de la table RELATION
CREATE TABLE RELATION (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sender_id INT NOT NULL,
    receiver_id INT NOT NULL,
    accepted TINYINT(1) DEFAULT 0, -- 0 pour non accepté, 1 pour accepté
    date_created DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_RELATION_USER_sender_id FOREIGN KEY (sender_id) REFERENCES USER(id) ON DELETE CASCADE,
    CONSTRAINT fk_RELATION_USER_receiver_id FOREIGN KEY (receiver_id) REFERENCES USER(id) ON DELETE CASCADE,
    CONSTRAINT idx_sender_receiver_UNIQUE UNIQUE (sender_id, receiver_id)
);
